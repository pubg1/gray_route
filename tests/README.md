# API 测试工具使用说明

## 文件说明

### 1. `test_api.py` - 自动化测试脚本
全面的API自动化测试，包括功能测试、性能测试和边界测试。

**使用方法:**
```bash
# 使用默认地址 (http://localhost:8000)
python test_api.py

# 指定API地址
python test_api.py http://your-api-server:8000
```

**测试内容:**
- ✅ 健康检查
- ✅ 基础匹配功能
- ✅ 参数化查询
- ✅ 边界情况处理
- ✅ 性能测试

### 2. `interactive_test.py` - 交互式测试工具
提供友好的交互界面，方便手动测试和调试。

**使用方法:**
```bash
# 启动交互式测试
python interactive_test.py

# 指定API地址
python interactive_test.py http://your-api-server:8000
```

**功能特性:**
- 🎮 交互式查询测试
- 🔄 批量预设测试案例
- 📊 详细的响应格式化显示
- ⚙️ 支持参数设置

## 快速开始

### 1. 启动API服务
```bash
# 在项目根目录
uvicorn app.main:app --host 0.0.0.0 --port 8000
```

### 2. 运行测试
```bash
# 进入测试目录
cd tests

# 运行自动化测试
python test_api.py

# 或运行交互式测试
python interactive_test.py
```

## 测试用例示例

### 基础查询
```
查询: 刹车发软
期望: 匹配到制动系统相关故障
```

### 参数化查询
```
查询: 发动机故障 system=发动机 topn=5
期望: 返回5个发动机系统的故障案例
```

### 复杂查询
```
查询: 冷车启动困难 model=宋 year=2019
期望: 匹配到相关车型的启动故障
```

## 响应格式说明

### 决策模式
- **direct**: 高置信度直接推荐
- **llm**: LLM辅助决策
- **fallback**: 兜底模式

### 匹配原因
- **语义近**: 语义相似度高
- **关键词命中**: BM25关键词匹配
- **系统一致**: 系统完全匹配
- **部件相近**: 部件相关匹配

### 评分说明
- **综合分数**: 最终排序分数 (0-1)
- **重排分数**: 深度学习重排序分数
- **语义分数**: 余弦相似度 (0-1)
- **关键词分数**: BM25分数
- **热度分数**: 故障流行度

## 故障排查

### 常见问题

1. **连接失败**
   ```
   ❌ 无法连接到服务
   ```
   - 检查API服务是否启动
   - 确认端口号是否正确
   - 检查防火墙设置

2. **响应超时**
   ```
   ❌ 请求超时
   ```
   - 检查服务器负载
   - 增加超时时间
   - 检查网络连接

3. **匹配结果为空**
   ```
   ❌ 没有找到匹配结果
   ```
   - 检查数据文件是否加载
   - 尝试更具体的查询描述
   - 检查索引文件是否正常

### 调试技巧

1. **使用健康检查**
   ```bash
   curl http://localhost:8000/health
   ```

2. **查看详细日志**
   - 启动服务时添加 `--log-level debug`
   - 检查控制台输出

3. **测试简单查询**
   ```bash
   curl "http://localhost:8000/match?q=刹车"
   ```

## 性能基准

### 响应时间
- **目标**: < 200ms (平均)
- **可接受**: < 500ms (平均)
- **需优化**: > 1000ms (平均)

### 准确率
- **优秀**: > 85%
- **良好**: 70-85%
- **需改进**: < 70%

## 扩展测试

### 添加自定义测试用例
在 `test_api.py` 中的 `test_match_basic()` 方法里添加:

```python
{
    "query": "您的测试查询",
    "expected_system": "期望的系统",
    "description": "测试描述"
}
```

### 性能压力测试
可以使用工具如 `locust` 或 `ab` 进行压力测试:

```bash
# 使用ab工具
ab -n 1000 -c 10 "http://localhost:8000/match?q=刹车发软"
```

## 联系支持

如果遇到问题或需要帮助，请：
1. 检查API文档: `docs/API_Documentation.md`
2. 查看测试日志输出
3. 提供详细的错误信息和复现步骤

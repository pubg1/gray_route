<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>OpenSearch 故障现象匹配 · 可视化测试台</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b1020; --panel:#141b2d; --muted:#7e8aa6; --text:#e7ecf6; --accent:#6aa6ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; font:14px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:radial-gradient(1200px 600px at 10% -10%, #18213b 0, transparent 60%), linear-gradient(#0b0f1e, #0b1020); }
    .container { max-width: 1100px; margin: 36px auto; padding: 0 16px; }
    header { display:flex; align-items:center; gap:14px; margin-bottom:16px; }
    header h1 { margin:0; font-size:20px; letter-spacing: .3px; }
    header .badge { padding:4px 8px; border-radius: 999px; background: #203055; color:#b7cdfb; font-size:12px; }
    .panel { background: rgba(20,27,45,.9); border:1px solid #2a3a63; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.25); overflow: hidden; }
    .fault-panel { margin-top: 24px; }
    .form { display:grid; grid-template-columns: 1fr 140px 140px 140px 120px 100px 100px; gap:10px; padding:16px; border-bottom:1px dashed #2a3a63; }
    .fault-form { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; padding:16px; border-bottom:1px dashed #2a3a63; }
    .form input, .form select, .form button { height:38px; border-radius:10px; border:1px solid #33446f; background:#0f1527; color:var(--text); padding:0 12px; outline:none; }
    .fault-form input, .fault-form select, .fault-form button { height:38px; border-radius:10px; border:1px solid #33446f; background:#0f1527; color:var(--text); padding:0 12px; outline:none; }
    .form input::placeholder { color:#98a3bf80; }
    .form button { background: linear-gradient(180deg, #2a63ff, #2052d6); border:0; font-weight:600; cursor:pointer; }
    .fault-form button { background: linear-gradient(180deg, #2a63ff, #2052d6); border:0; font-weight:600; cursor:pointer; }
    .form button.secondary { background:#0f1527; border:1px solid #2a3a63; }
    .fault-form button.secondary { background:#0f1527; border:1px solid #2a3a63; }
    .options { display:flex; flex-wrap:wrap; gap:16px; padding:12px 16px; border-bottom:1px dashed #2a3a63; background:rgba(11,17,32,0.35); }
    .options label { display:flex; align-items:center; gap:8px; color:#c5d4ff; font-size:13px; }
    .options input[type="checkbox"] { width:16px; height:16px; accent-color:#4f8cff; }
    .options input[type="range"] { width:160px; }
    .options input[type="number"] { width:90px; height:32px; border-radius:8px; border:1px solid #33446f; background:#0f1527; color:var(--text); padding:0 8px; }
    .meta { display:flex; align-items:center; gap:12px; padding:10px 16px; color: var(--muted); font-size:12px; }
    .meta .dot { width:6px; height:6px; border-radius:50%; display:inline-block; margin-right:6px; background:#4e5d86; }
    .examples { padding: 12px 16px; display:flex; flex-wrap: wrap; gap:8px; border-top:1px dashed #2a3a63; }
    .examples button { border:1px solid #2a3a63; background:#0f1527; color:#cbd5e1; border-radius: 999px; padding:6px 10px; cursor:pointer; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 10px; padding: 16px; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { padding: 14px; border:1px solid #2a3a63; border-radius: 12px; background: #0e1426; }
    .row { display:flex; align-items: center; justify-content: space-between; gap: 10px; }
    .score { font-weight:800; letter-spacing:.2px; }
    .score.ok { color: var(--ok); }
    .score.gray { color: var(--warn); }
    .score.low { color: var(--bad); }
    .id { color:#9fb6f9; font-weight:700; }
    .why { display:flex; flex-wrap: wrap; gap:6px; margin-top:6px; }
    .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#152247; color:#b7cdfb; border:1px solid #2a3a63; }
    .text { margin-top:8px; font-size:15px; }
    .source-line { margin-top:6px; font-size:12px; color:#8ba2d8; }
    mark { background: #fde68a99; color: #fff; padding: 0 .2em; border-radius: 4px; }
    details { padding: 0 16px 16px; }
    pre { white-space: pre-wrap; word-break: break-word; background: #0b1020; padding: 12px; border-radius: 10px; border:1px solid #2a3a63; }
    .footer { text-align:center; color:#8b97b6; margin-top:16px; font-size:12px; }
    .fault-header { display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px dashed #2a3a63; }
    .fault-header h2 { margin:0; font-size:18px; }
    .fault-meta { padding:12px 16px; color:#a9b7d9; font-size:13px; border-bottom:1px dashed #2a3a63; }
    .fault-results { display:grid; grid-template-columns: 1fr; gap:10px; padding:16px; }
    @media (min-width: 860px) { .fault-results { grid-template-columns: 1fr 1fr; } }
    .fault-card { padding:14px; border:1px solid #2a3a63; border-radius:12px; background:#0e1426; display:flex; flex-direction:column; gap:8px; }
    .fault-card h3 { margin:0; font-size:16px; color:#9fb6f9; }
    .fault-card .score { align-self:flex-start; padding:2px 10px; border-radius:999px; background:#152247; font-size:12px; color:#6aa6ff; }
    .fault-card .meta-line { font-size:12px; color:#94a3b8; }
    .fault-card .discussion { font-size:14px; line-height:1.6; color:#e2e8f0; }
    .fault-empty { padding:20px; color:#7e8aa6; font-size:14px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>OpenSearch 故障现象匹配 · 可视化测试台</h1>
      <span id="decision-badge" class="badge">未查询</span>
    </header>

    <div class="panel">
      <form id="form" class="form" onsubmit="return false;">
        <input id="q" placeholder="输入故障现象，如：刹车发软 车身发飘" />
        <input id="system" placeholder="系统（可选）如：制动" />
        <input id="part" placeholder="部件（可选）如：制动踏板" />
        <input id="vehicletype" placeholder="车型（可选）如：CT4" />
        <input id="fault_code" placeholder="故障码（可选）如：P0300" />
        <select id="topn">
          <option value="3">Top-3</option>
          <option value="5">Top-5</option>
          <option value="10">Top-10</option>
        </select>
        <div style="display:flex; gap:8px;">
          <button id="run">查询</button>
          <button id="reset" class="secondary" type="button">清空</button>
        </div>
      </form>

      <div class="options">
        <label><input type="checkbox" id="use_decision" checked /> 返回灰区决策信息</label>
        <label><input type="checkbox" id="use_semantic" checked /> 启用语义向量检索</label>
        <label>语义权重
          <input type="range" id="semantic_weight" min="0.30" max="0.90" step="0.05" value="0.60" />
          <span id="semantic_weight_value">0.60</span>
        </label>
        <label>向量 TopK
          <input type="number" id="vector_k" min="10" max="200" step="10" value="50" />
        </label>
        <label><input type="checkbox" id="use_llm" /> 灰区调用 LLM 精选</label>
        <label>LLM 候选数
          <input type="number" id="llm_topn" min="3" max="10" step="1" value="5" />
        </label>
      </div>

      <div class="meta">
        <span><span class="dot"></span>服务：<b id="endpoint"></b></span>
        <span><span class="dot"></span>耗时：<b id="latency">-</b> ms</span>
        <span><span class="dot"></span>决策：<b id="decision">-</b></span>
        <span><span class="dot"></span>置信度：<b id="conf">-</b></span>
        <span><span class="dot"></span>语义检索：<b id="semantic-mode">-</b></span>
        <span><span class="dot"></span>LLM：<b id="llm-mode">-</b></span>
      </div>

      <div class="examples" id="examples"></div>

      <div class="grid" id="results"></div>

      <details>
        <summary>查看原始响应 JSON</summary>
        <pre id="raw"></pre>
      </details>
    </div>

    <div class="panel fault-panel">
      <div class="fault-header">
        <h2>故障点检索（discussion 字段）</h2>
        <span class="badge" id="fault-total">未查询</span>
      </div>

      <form id="fault-form" class="fault-form" onsubmit="return false;">
        <input id="fp_brand" placeholder="车辆品牌，如：别克" />
        <input id="fp_name" placeholder="车型名称，如：昂科威" />
        <input id="fp_year" placeholder="年份，如：2021" />
        <input id="fp_code" placeholder="故障码，如：P0300" />
        <input id="fp_unit" placeholder="损坏控制单元，如：发动机控制模块" />
        <input id="fp_symptom" placeholder="故障现象，如：加速无力" />
        <select id="fp_size">
          <option value="3">返回 3 条</option>
          <option value="5" selected>返回 5 条</option>
          <option value="8">返回 8 条</option>
          <option value="10">返回 10 条</option>
        </select>
        <div style="display:flex; gap:8px;">
          <button id="fault-run">检索</button>
          <button id="fault-reset" type="button" class="secondary">清空</button>
        </div>
      </form>

      <div class="fault-meta" id="fault-meta">请至少填写一个条件后再检索。</div>
      <div class="examples" id="fault-examples"></div>
      <div class="fault-results" id="fault-results"></div>
    </div>

    <div class="footer">基于 AWS OpenSearch 的多字段匹配 + BM25 算法 + 故障现象智能匹配</div>
  </div>

  <script>
    const API_BASE = location.origin; // 与后端同源；你也可以改成 'http://127.0.0.1:8080'
    document.getElementById('endpoint').textContent = API_BASE;

    const SOURCE_LABEL = { keyword: "关键词召回", semantic: "语义召回" };
    const formatSources = (list)=>{
      if (!Array.isArray(list) || !list.length) return "";
      return list.map(s=>SOURCE_LABEL[s] || s).join(' + ');
    };

    const EXAMPLES = [
      {q:"发动机无法启动", system:"发动机", part:"启动系统", vehicletype:"", fault_code:""},
      {q:"变速器挂D档延迟", system:"变速箱/传动", part:"变速器", vehicletype:"", fault_code:""},
      {q:"刹车发软 制动距离长", system:"制动", part:"制动系统", vehicletype:"", fault_code:""},
      {q:"发动机故障灯亮", system:"发动机", part:"发动机控制", vehicletype:"", fault_code:"P0300"},
      {q:"怠速不稳 抖动", system:"发动机", part:"怠速控制", vehicletype:"", fault_code:"P0171"},
      {q:"ABS故障", system:"制动", part:"ABS系统", vehicletype:"", fault_code:"C1234"},
    ];

    const exWrap = document.getElementById('examples');
    EXAMPLES.forEach(e=>{
      const b = document.createElement('button');
      b.textContent = `${e.q}（${e.system}/${e.part}）`;
      b.onclick = ()=>{ q.value=e.q; system.value=e.system; part.value=e.part; vehicletype.value=e.vehicletype || ""; fault_code.value=e.fault_code; runQuery(); };
      exWrap.appendChild(b);
    });

    const q = document.getElementById('q');
    const system = document.getElementById('system');
    const part = document.getElementById('part');
    const vehicletype = document.getElementById('vehicletype');
    const fault_code = document.getElementById('fault_code');
    const topn = document.getElementById('topn');
    const runBtn = document.getElementById('run');
    const resetBtn = document.getElementById('reset');
    const useDecision = document.getElementById('use_decision');
    const useSemantic = document.getElementById('use_semantic');
    const semanticWeight = document.getElementById('semantic_weight');
    const semanticWeightValue = document.getElementById('semantic_weight_value');
    const vectorK = document.getElementById('vector_k');
    const semanticMode = document.getElementById('semantic-mode');
    const useLLM = document.getElementById('use_llm');
    const llmTopn = document.getElementById('llm_topn');
    const llmMode = document.getElementById('llm-mode');

    const faultBrand = document.getElementById('fp_brand');
    const faultName = document.getElementById('fp_name');
    const faultYear = document.getElementById('fp_year');
    const faultCode = document.getElementById('fp_code');
    const faultUnit = document.getElementById('fp_unit');
    const faultSymptom = document.getElementById('fp_symptom');
    const faultSize = document.getElementById('fp_size');
    const faultRunBtn = document.getElementById('fault-run');
    const faultResetBtn = document.getElementById('fault-reset');
    const faultResults = document.getElementById('fault-results');
    const faultMeta = document.getElementById('fault-meta');
    const faultTotal = document.getElementById('fault-total');
    const faultExamplesWrap = document.getElementById('fault-examples');

    const FAULT_EXAMPLES = [
      { brand: '别克', name: '昂科威', year: '2021', code: 'P0014', unit: '发动机控制模块', symptom: '发动机动力不足' },
      { brand: '凯迪拉克', name: 'CT5', year: '2020', code: 'P0300', unit: '点火系统', symptom: '怠速抖动' },
      { brand: '雪佛兰', name: '探界者', year: '2019', code: 'C0040', unit: 'ABS控制模块', symptom: '制动踏板震动' },
      { brand: '别克', name: 'GL8', year: '2022', code: 'U0100', unit: '车身控制模块', symptom: '仪表盘报警灯常亮' },
    ];

    FAULT_EXAMPLES.forEach(example => {
      const button = document.createElement('button');
      button.type = 'button';
      const title = [example.brand, example.name, example.year].filter(Boolean).join(' ');
      const faultLabel = example.symptom ? `｜${example.symptom}` : '';
      button.textContent = `${title}${faultLabel}`;
      button.onclick = () => {
        faultBrand.value = example.brand || '';
        faultName.value = example.name || '';
        faultYear.value = example.year || '';
        faultCode.value = example.code || '';
        faultUnit.value = example.unit || '';
        faultSymptom.value = example.symptom || '';
        runFaultQuery();
      };
      faultExamplesWrap.appendChild(button);
    });

    runBtn.addEventListener('click', runQuery);
    semanticWeight.addEventListener('input', ()=>{
      semanticWeightValue.textContent = Number(semanticWeight.value).toFixed(2);
    });
    resetBtn.addEventListener('click', ()=>{
      q.value = ""; system.value=""; part.value=""; vehicletype.value=""; fault_code.value="";
      useDecision.checked = true;
      useSemantic.checked = true;
      semanticWeight.value = 0.60; semanticWeightValue.textContent = "0.60";
      vectorK.value = 50;
      useLLM.checked = false;
      llmTopn.value = 5;
      setDecision({mode:"未查询", confidence:null});
      setLatency(null);
      document.getElementById('results').innerHTML = "";
      document.getElementById('raw').textContent = "";
      document.getElementById('decision-badge').textContent = "未查询";
      semanticMode.textContent = "-";
      llmMode.textContent = "-";
    });

    faultRunBtn.addEventListener('click', runFaultQuery);
    document.getElementById('fault-form').addEventListener('submit', runFaultQuery);
    faultResetBtn.addEventListener('click', resetFaultForm);

    function setLatency(ms){
      document.getElementById('latency').textContent = ms==null ? "-" : ms.toFixed(0);
    }
    function setDecision(dec){
      const d = dec?.mode ?? "-";
      const c = dec?.confidence ?? null;
      document.getElementById('decision').textContent = d;
      document.getElementById('conf').textContent = c==null ? "-" : (c.toFixed(3));
      const badge = document.getElementById('decision-badge');
      const badgeMap = {
        "direct": "直接命中",
        "gray": "灰区匹配",
        "fallback": "兜底",
        "llm": "LLM 精选",
        "opensearch": "OpenSearch",
        "no_match": "无匹配",
        "查询中": "查询中",
        "错误": "错误"
      };
      badge.textContent = badgeMap[d] || "未查询";
    }

    function colorScore(s){
      if (s >= 0.84) return "ok";
      if (s >= 0.65) return "gray";
      return "low";
    }

    function escHTML(s){ return s.replace(/[&<>]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[m])); }

    // 简单高亮：把中文和空格分割出的 token（≥2字）做全文替换
    function highlight(text, query){
      const toks = Array.from(new Set(
        query.split(/\s+/).map(t=>t.trim()).filter(t=>t && t.length>=2)
      ));
      let html = escHTML(text);
      toks.forEach(tok=>{
        const re = new RegExp(tok.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "g");
        html = html.replace(re, m=>`<mark>${m}</mark>`);
      });
      return html;
    }

    function sanitizeHighlight(raw){
      if (!raw) return '';
      const template = document.createElement('template');
      template.innerHTML = raw;
      template.content.querySelectorAll('*').forEach(node=>{
        if (node.tagName && node.tagName.toLowerCase() === 'mark') return;
        if (node.tagName && node.tagName.toLowerCase() === 'script') {
          node.remove();
          return;
        }
        const span = document.createElement('span');
        span.textContent = node.outerHTML;
        node.replaceWith(span);
      });
      return template.innerHTML;
    }

    async function runQuery(){
      const qv = q.value.trim();
      if (!qv) { q.focus(); return; }
      
      const semanticVal = parseFloat(semanticWeight.value);
      const vectorTop = parseInt(vectorK.value, 10);
      const requestBody = {
        q: qv,
        size: parseInt(topn.value),
        use_decision: useDecision.checked,
        use_semantic: useSemantic.checked,
        semantic_weight: Number.isFinite(semanticVal) ? semanticVal : 0.6,
        vector_k: Number.isFinite(vectorTop) ? vectorTop : 50,
        use_llm: useLLM.checked,
        llm_topn: parseInt(llmTopn.value, 10) || 5
      };

      if (system.value.trim()) requestBody.system = system.value.trim();
      if (part.value.trim()) requestBody.part = part.value.trim();
      if (vehicletype.value.trim()) requestBody.vehicletype = vehicletype.value.trim();
      if (fault_code.value.trim()) requestBody.fault_code = fault_code.value.trim();

      const url = API_BASE + "/opensearch/match";
      const t0 = performance.now();
      setDecision({mode:"查询中", confidence:null});
      semanticMode.textContent = useSemantic.checked ? "开启" : "关闭";
      llmMode.textContent = useLLM.checked ? "请求中" : "关闭";
      try{
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json" 
          },
          body: JSON.stringify(requestBody)
        });
        const data = await resp.json();
        const t1 = performance.now();
        setLatency(t1 - t0);
        // 处理决策信息
        if (data.decision) {
          setDecision(data.decision);
        } else {
          // 如果没有决策信息，根据结果推断
          const topScore = data.top && data.top.length > 0 ? data.top[0].final_score : 0;
          let decision = {mode: "opensearch", confidence: topScore};
          if (topScore >= 0.84) {
            decision.mode = "direct";
          } else if (topScore >= 0.65) {
            decision.mode = "gray";
          } else {
            decision.mode = "fallback";
          }
          setDecision(decision);
        }
        const meta = data.metadata || {};
        if (meta.semantic_used) {
          const weightText = typeof meta.semantic_weight === 'number' ? meta.semantic_weight.toFixed(2) : semanticWeightValue.textContent;
          const kText = meta.vector_k ? ` · k=${meta.vector_k}` : '';
          semanticMode.textContent = `开启 / 权重 ${weightText}${kText}`;
        } else {
          semanticMode.textContent = "关闭";
        }
        if (meta.llm_used) {
          const resp = meta.llm_response || {};
          const why = resp.why ? ` / ${resp.why}` : '';
          const conf = typeof resp.confidence === 'number' ? ` / 置信 ${Number(resp.confidence).toFixed(2)}` : '';
          llmMode.textContent = `已调用${why}${conf}`;
        } else {
          llmMode.textContent = useLLM.checked ? "未触发" : "关闭";
        }
        document.getElementById('raw').textContent = JSON.stringify(data, null, 2);

        const grid = document.getElementById('results');
        grid.innerHTML = "";
        (data.top || []).forEach((c, idx)=>{
          const card = document.createElement('div');
          card.className = "card";
          const scClass = "score " + colorScore(c.final_score ?? 0);
          card.innerHTML = `
            <div class="row">
              <div>
                <span class="id">#${escHTML(c.id || '?')}</span>
                <span style="color:#8ea4ec;margin-left:8px">${escHTML(c.system || '-')}/${escHTML(c.part || '-')}</span>
                ${c.spare4 ? `<span style="color:#f59e0b;margin-left:8px;font-weight:600">[${escHTML(c.spare4)}]</span>` : ''}
              </div>
              <div class="${scClass}">${(c.final_score ?? 0).toFixed(3)}</div>
            </div>
            <div class="text">${highlight(c.text || '', qv)}</div>
            ${c.sources && c.sources.length ? `<div class="source-line">来源：${escHTML(formatSources(c.sources))}</div>` : ''}
            <div class="why">${(c.why || []).map(w=>`<span class="tag">${escHTML(w)}</span>`).join('')}</div>
            <div style="margin-top:6px; color:#94a3b8; font-size:12px">
              融合=${(c.rerank_score??0).toFixed(3)} ｜ 语义=${(c.cosine??0).toFixed(3)} ｜ bm25=${(c.bm25_score??0).toFixed(3)}
            </div>
          `;
          grid.appendChild(card);
        });

      }catch(err){
        setLatency(null);
        setDecision({mode:"错误", confidence:null});
        document.getElementById('raw').textContent = String(err);
        semanticMode.textContent = "错误";
        llmMode.textContent = "错误";
      }
    }

    function resetFaultForm(){
      faultBrand.value = "";
      faultName.value = "";
      faultYear.value = "";
      faultCode.value = "";
      faultUnit.value = "";
      faultSymptom.value = "";
      faultSize.value = "5";
      faultResults.innerHTML = "";
      faultMeta.textContent = "请至少填写一个条件后再检索。";
      faultTotal.textContent = "未查询";
    }

    async function runFaultQuery(evt){
      if (evt) evt.preventDefault();

      const payload = { size: parseInt(faultSize.value, 10) || 5 };
      const fieldMap = [
        ['vehicle_brand', faultBrand.value.trim()],
        ['vehicle_name', faultName.value.trim()],
        ['model_year', faultYear.value.trim()],
        ['fault_code', faultCode.value.trim()],
        ['control_unit', faultUnit.value.trim()],
        ['symptom', faultSymptom.value.trim()],
      ];

      let hasCondition = false;
      fieldMap.forEach(([key, val])=>{
        if (val) {
          payload[key] = val;
          hasCondition = true;
        }
      });

      if (!hasCondition) {
        faultMeta.textContent = "请至少填写一个条件后再检索。";
        faultTotal.textContent = "未查询";
        return;
      }

      faultMeta.textContent = "检索中...";
      faultTotal.textContent = "检索中";
      faultResults.innerHTML = "";

      try {
        const resp = await fetch(API_BASE + '/opensearch/fault-points', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
          },
          body: JSON.stringify(payload),
        });
        const data = await resp.json();

        if (data.error) {
          faultMeta.textContent = data.message || data.error || '查询失败';
          faultTotal.textContent = '错误';
          return;
        }

        const list = data.fault_points || [];
        faultTotal.textContent = `${list.length} / ${data.total ?? 0}`;
        if (!list.length) {
          faultMeta.textContent = '未检索到匹配的故障点，请调整条件重试。';
          faultResults.innerHTML = '<div class="fault-empty">暂无数据</div>';
          return;
        }

        faultMeta.textContent = `共 ${data.total ?? list.length} 条匹配，展示 ${list.length} 条故障点。`;
        faultResults.innerHTML = '';

        const highlightQuery = [payload.symptom, payload.control_unit].filter(Boolean).join(' ');

        list.forEach(item => {
          const card = document.createElement('div');
          card.className = 'fault-card';
          const titleParts = [item.vehiclebrand, item.vehicletype, item.modelyear].filter(Boolean);
          const title = titleParts.length ? titleParts.join(' / ') : '未知车型';
          const systemLine = [
            item.system ? `系统：${escHTML(item.system)}` : '',
            item.part ? `部件：${escHTML(item.part)}` : ''
          ].filter(Boolean).join(' ｜ ');
          const codeLine = item.faultcode ? `故障码：${escHTML(item.faultcode)}` : '';
          const discussionHTML = item.highlight ? sanitizeHighlight(item.highlight) : highlight(item.discussion || '', highlightQuery);

          card.innerHTML = `
            <span class="score">得分 ${Number(item.score || 0).toFixed(2)}</span>
            <h3>${escHTML(title)}</h3>
            ${systemLine ? `<div class="meta-line">${systemLine}</div>` : ''}
            ${codeLine ? `<div class="meta-line">${codeLine}</div>` : ''}
            <div class="discussion">${discussionHTML || '暂无故障点描述'}</div>
          `;

          faultResults.appendChild(card);
        });

      } catch (err) {
        faultMeta.textContent = '请求失败：' + err;
        faultTotal.textContent = '错误';
        faultResults.innerHTML = '';
      }
    }
  </script>
</body>
</html>
